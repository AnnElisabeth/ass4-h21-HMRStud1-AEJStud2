---
title: "Assignment 4"
author: "Heidi and Ann Elisabeth"
output: html_notebook
---

```{r setup}
suppressPackageStartupMessages({
library(PxWebApiData)
library(tidyverse)
library(lubridate)
})

```

Les oppgaveteksten og malene nøye. Innhenting av data via
hent-sbb-data.Rmd skal skje i en undemappe kalt data. Har opprettet denn
og flyttet de respektive filene ned i denne mappen.

```{r Relevante kommunenummer}
load("knr.Rdata")
```

```{r}
pm2_raw <- ApiData(
urlToData = "06035",
Region = knr,
ContentsCode = "KvPris",
Boligtype = "01",
Tid = c(as.character(2002:2017))
)
```

```{r}
# vil ikke virke
#ApiData("http://data.ssb.no/api/v0/no/table/06035")
```

```{r}
# structure pm2-raw
str(pm2_raw)
```

Ser at resultatet fra ssb er en liste med 2 elementer. Element 2 er kalt
dataset og er stort sett der vi henter verdier. For pm2_raw er vi
imidlertid også interessert i det første elementet der vi vil hente ut
kommunenavn fra varaibelen region. Se malens beskrivelse av hvordan en
kan endre navn på dette elementet fra '06035: Selveierboliger, etter
region, boligtype, statistikkvariabel og år:' til 'desc' for å gjøre
ting enklere.

```{r}
pm2 <- pm2_raw$dataset %>%
  tibble() %>%
  select(-Boligtype, -ContentsCode) %>%
  rename(
    knr = Region, 
    aar = Tid, 
    pm2 = value
  )
head(pm2)
```

```{r}
names(pm2_raw)[[1]] <- "desc"

```

```{r}
pm2 <- pm2 %>% 
  mutate(
    knavn = pm2_raw$desc$region) %>%
  group_by(knr) %>%
  select(knr, aar, pm2, knavn)
 
```

```{r}
str_view(pm2_raw, "knr")

```

```{r}
load("test_string_tib.Rdata")
moenster <- '\\s*\\([\\d\\s-]*\\d*\\)\\s*$'
```

```{r}
pm2 <- pm2 %>%
  mutate(
    knavn = str_replace(knavn,moenster,"")
  )
```
 

```{r}
pm2 %>% 
   map_df(is.na) %>% 
   map_df(sum) %>%
  as.tibble()
```

Complete cases

```{r}
pm2_2006 <- pm2 %>%
  filter(aar >= 2006) %>%
  pivot_wider(names_from = aar,
              values_from = pm2)
```


```{r}
pm2_2006 %>%
  complete.cases() %>%
  sum()
```

```{r}
pm2_2008 <- pm2 %>%
  filter(aar >= 2008) %>%
  pivot_wider(
    names_from = aar,
    values_from = pm2
           )
```


```{r}
pm2_2008 %>%
  complete.cases() %>%
  sum()

```

#time to clean up
dinna virker ikke
```{r}
rm(pm2_raw)
```


#Befolkning

ny tabell 
```{r}
pop_08_17_ya_raw <- ApiData(
urlToData = "07459",
Region = knr,
Kjonn = c(1,2),
Alder = list("agg:TredeltGrupperingB2",
             c("F20-64")),
Tid = c(as.character(2008:2017))
)
pop_08_17_ya_raw <- pop_08_17_ya_raw$dataset %>%
  select(-ContentsCode, -Alder)
```


```{r}
pop_08_17_ya <- pop_08_17_ya_raw %>%
  pivot_wider(
    id_cols = c(Region, Tid),
    names_prefix = "sex",
    names_from = Kjonn,
    values_from = value)
```

nye navn

```{r}
names(pop_08_17_ya)[[1]] <- "knr"
names(pop_08_17_ya)[[2]] <- "aar"
names(pop_08_17_ya)[[3]] <- "ya_Menn"
names(pop_08_17_ya)[[4]] <- "ya_Kvinner"
```

```{r}
pop_08_17_ya <- pop_08_17_ya %>%
  mutate(ya_total = ya_Menn + ya_Kvinner)
```

```{r}
dim(pop_08_17_ya)
```

